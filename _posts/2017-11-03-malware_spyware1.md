---
layout: post
title: Malware Analysys Spyware 1
---
This week I've had to do another malware analysis, again with a phising email as entry vector. Due to in my personal malware analysis lab I don't have Outlook and the malware was attached in a .msg, first of all I had to looking for the way to extract it. To do that, I found the script [msg-extractor](https://github.com/mattgwwalker/msg-extractor) which I was able to use in the Windows machine. The files extracted was two .ace compressed files that had two identical PE Windows executables but with different name. Despite the fact that the analysis was deep, I was not able to know exactly what the malware do but different things could be determined:

Both executables are written in Visual Basic 5.0 or Visual Basic 6.0 and no presence of packers that could obfuscate their code is detected (neither by the result thrown by PeID nor judging by the comparison of sizes between the raw size and the virtual size):

![evidence1]({{ site.baseurl }}/images/mlwr_spyware1.PNG)

As it can be checked, the executable has GUI interface but no form was shown:

![evidence2]({{ site.baseurl }}/images/mlwr_spyware2.PNG)

I was able to get the images stored in the .rsrc section, but they were not be relevant for the analysis. The executable has a compilation date of 10/25/2017, which I can not corroborate whether it is real or not (it would be interesting to compare it with the date of the message in which it came). What can be concluded is that both executables had as their internal name at the time of execution "Udskriftskommandoernes1.exe" (I have not found references on Internet about it):

![evidence3]({{ site.baseurl }}/images/mlwr_spyware3.PNG)

Both executables are signed by DigiCert certificate and that was very important to get the first, and unique, IOC. They were able to be extracted with disitool.py (included in [Remnux](https://remnux.org/)) and openssl tools:

```
disitool.py extract Consignee\ Details.exe consignee-sig.der
openssl pkcs7 -inform DER -print_certs -text -in consignee-sig.der > consignee-sig.txt
```

Looking at the certificate, the rsa public key (both 2048 and 4096 bits) is present inside of the binary, more specifically as from  0047ae0 memory direction:


![evidence4]({{ site.baseurl }}/images/mlwr_spyware4.PNG)
